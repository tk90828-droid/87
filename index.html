<!doctype html>  
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Taiwan Pride 🌈｜11×9 排桌表（Leader Dock + Popover）— fixed</title>
<style>
  :root{
    --bg:#0A0B0F; --card:#10131A; --muted:#9AA4AF; --fg:#F2F5F8; --border:#1f2430;
    --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --rainbow: linear-gradient(90deg,#ff5f6d,#ffc371,#9be15d,#00e3ae,#45aaf2,#9b59b6);
    --btn-grad: linear-gradient(90deg,#7dd3fc,#86efac);
    --gold-grad: linear-gradient(90deg,#caa757,#f6e27a,#d4af37);
    --colw: 100px;
    --gap: 8px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "Segoe UI", Roboto, Helvetica, Arial;
    background:var(--bg); color:var(--fg);
  }
  .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
  .h{font-weight:900;font-size:20px}
  .sub{color:var(--muted);font-size:13px}
  .rb{height:2px;background:var(--rainbow);opacity:.6;border-radius:2px;margin:6px 0 10px}

  .bar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin:10px 0}
  .ctrls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .ctrls label{font-size:12px;color:var(--muted)}
  .ctrls input[type="range"]{width:180px}
  .hint{font-size:12px;color:var(--muted)}

  .btn{appearance:none;border:1px solid var(--border);background:#0f1117;color:#e5e7eb;padding:6px 10px;border-radius:999px;cursor:pointer}
  .btn.primary{background:var(--btn-grad);border:none;color:#0b1220;font-weight:800}
  .btn.toggle[aria-pressed="true"]{outline:2px solid #3b82f6}

  /* Dock */
  .dock{margin-top:8px;border:1px solid var(--border);border-radius:14px;padding:10px;background:var(--card)}
  .dock-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .dock-body{display:flex;flex-wrap:wrap;gap:8px;min-height:44px;padding:6px;border:1px dashed #2b3244;border-radius:10px}
  .placeholder{color:var(--muted);font-size:12px}

  /* Leader pill —— 移除小圓圈，只保留名稱；仍可拖曳 */
  .pill{
    display:inline-flex;align-items:center;gap:6px;
    padding:4px 8px;border:1px solid var(--border);
    border-radius:999px;background:#0f1117;cursor:grab;
    user-select:none;max-width:100%;
  }
  .pill:active{cursor:grabbing}
  .pill .name{
    font-weight:800;flex:1;min-width:0;
    overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    display:inline-block;background:var(--gold-grad);
    -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
    font-size:9px; line-height:1.1;
  }

  /* Grid —— 兩行：一行桌名(+按鈕)、一行桌長（避免重疊） */
  .grid-wrap{margin-top:12px}
  .grid{
    --w: var(--colw);
    display:grid;grid-template-columns:repeat(11,var(--w));gap:var(--gap);
    width:min(100%, calc(var(--colw)*11 + var(--gap)*10));
  }
  .cell{
    border:1px solid var(--border);border-radius:12px;
    padding:4px 6px;
    background:var(--card);position:relative;
  }
  .cell .head{
    display:flex;align-items:center;gap:6px;
    margin-bottom:4px;
    min-height:0;
  }
  .table-name{
    flex:0 0 48px;                 /* 縮小：三位數字寬度 */
    width:48px;
    padding:2px 6px;
    text-align:center;             /* 置中顯示 */
    border-radius:8px;border:1px solid #2b3244;background:#0f1117;color:#e5e7eb;
    font-size:12px;height:24px;line-height:20px;
  }
  .table-name[readonly]{opacity:.95;font-weight:700;}

  /* 人數顯示（桌名與 + 之間） */
  .head-count{
    min-width:18px;
    font-size:12px;
    color:var(--muted);
    text-align:center;
  }

  /* 右側 + 按鈕：無外圈、實心藍色「+」 */
  .table-plus{
    flex:0 0 auto;
    background:none;
    border:none;
    color:#3b82f6;                 /* 藍色實心字 */
    font-weight:900;
    font-size:18px;
    line-height:1;
    padding:0 2px;
    display:inline-flex;align-items:center;justify-content:center;
    cursor:pointer;
  }

  /* 第二行：專放 Leader pill，不與桌名重疊 */
  .drop{
    min-height:22px;
    display:flex;align-items:center;flex-wrap:wrap;gap:6px
  }
  .cell[data-dropzone="cell"]{outline-offset:-2px}
  .cell.dragover{outline:2px dashed #3b82f6}

  /* Popover */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
  .popover{width:min(560px,92vw);max-height:70vh;overflow:auto;background:#0f1117;border:1px solid #2b3244;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.5);padding:12px}
  .po-head{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .po-title{font-weight:900}
  .po-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
  .po-item{display:flex;align-items:center;gap:8px;border:1px solid #2b3244;border-radius:10px;padding:6px 8px;background:#10131A}
  .po-item .nm{font-weight:800}
  .po-item .ig{font-size:12px;color:#9AA4AF;margin-left:auto}

  .toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);background:#0f1117;border:1px solid #2b3244;color:#e5e7eb;padding:8px 12px;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.45);opacity:0;transition:opacity .25s;z-index:60}
  .toast.show{opacity:1}
</style>
</head>
<body>
  <div class="wrap">
    <div class="h">11×9 排桌表｜Leader Dock + Popover</div>
    <div class="sub">資料直接讀取雲端 roster；僅「儲存」時呼叫 GAS 回填 number。</div>
    <div class="rb"></div>

    <!-- Top controls -->
    <div class="bar">
      <div class="ctrls">
        <label for="colw">欄寬</label>
        <input id="colw" type="range" min="30" max="250" step="1" value="100" />
        <span id="colwVal" class="hint">100px</span>
        <button id="btnAuto" class="btn">自動排列（依 Leader 名稱）</button>
        <button id="btnMode" class="btn toggle" aria-pressed="false" title="覆蓋 / 交換">覆蓋模式</button>
      </div>
      <div class="ctrls">
        <button id="btnSave" class="btn primary">儲存（回填 number）</button>
      </div>
    </div>

    <!-- Leader Dock -->
    <section class="dock" aria-label="Leader Dock" id="dock">
      <div class="dock-title">
        <div class="h" style="font-size:16px">Leaders</div>
        <div class="sub" id="dockCount">0 位</div>
      </div>
      <div class="dock-body" id="dockBody" data-dropzone="dock">
        <div class="placeholder">將 Leader 拖曳到任一桌格，或拖回此 Dock。</div>
      </div>
    </section>

    <!-- Grid -->
    <div class="grid-wrap">
      <div class="grid" id="grid"></div>
    </div>
  </div>

  <!-- Popover -->
  <div class="backdrop" id="poBack">
    <div class="popover" role="dialog" aria-modal="true">
      <div class="po-head">
        <div class="po-title" id="poTitle">成員清單</div>
        <button class="btn" id="poClose">關閉</button>
      </div>
      <div class="rb"></div>
      <div id="poList" class="po-list"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/***** (1) 設定區：請確認以下兩個常數 *****/
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbykkFpq9sT-hTXPOEsqtBTUqMDs0U7nrzO_221cr9c-E4x62IuIWblUuCOWF1C4SAHlcw/exec';
const ROSTER_URL = 'https://docs.google.com/spreadsheets/d/1DY4TajQDdvikPfM_-A6St5CCW996NtQkclC2IG4PJ4s/gviz/tq?tqx=out:json&sheet=roster';

/***** (2) 快捷 *****/
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const toastBox = $('#toast');
function toast(msg){ toastBox.textContent = msg; toastBox.classList.add('show'); setTimeout(()=>toastBox.classList.remove('show'), 1800); }

/***** (3) Grid 參數 *****/
const ROWS = 9, COLS = 11, CELLS = ROWS*COLS;

/***** (4) 全域狀態 *****/
const state = {
  rows: [],
  leaders: [],
  membersByLeader: new Map(),
  pos: new Map(),
  swapMode: false
};

/***** (5) 欄名正規化 *****/
const needKeys = ['item','number','name','ig','country','flag','leader','link','status'];
const normKey = s => (s||'').toString().toLowerCase().replace(/\s|　|_/g,'').trim();

/***** (5a) 桌名本地保存（localStorage） *****/
const STORAGE_KEY = 'tp_table_names_v1';
function loadTableNames(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }catch{ return {}; }
}
function saveTableNames(map){ localStorage.setItem(STORAGE_KEY, JSON.stringify(map)); }
const tableNames = loadTableNames();
function getTableName(idx){ return tableNames[idx] || ''; }
function setTableName(idx, val){
  if (val) tableNames[idx] = val; else delete tableNames[idx];
  saveTableNames(tableNames);
}

/***** (5b) 固定桌名（由座標 X,Y 指定；每次開啟皆顯示） *****/
// 將 (x,y) 轉成 grid 索引（0-based）
const xyToIdx = (x,y) => (y-1)*COLS + (x-1);

// 你的清單（僅填入提供的座標，其餘維持空白）
const PRESET_TABLES = new Map([
  [xyToIdx(1,1),'508'], [xyToIdx(2,1),'517'], [xyToIdx(3,1),'518'], [xyToIdx(4,1),'531'], [xyToIdx(5,1),'532'], [xyToIdx(6,1),'533'],
  [xyToIdx(1,2),'507'], [xyToIdx(2,2),'516'], [xyToIdx(3,2),'519'], [xyToIdx(4,2),'535'], [xyToIdx(5,2),'536'], [xyToIdx(6,2),'537'],
  [xyToIdx(1,3),'506'], [xyToIdx(2,3),'515'], [xyToIdx(3,3),'520'], [xyToIdx(6,3),'428'], [xyToIdx(8,3),'430'], [xyToIdx(11,3),'433'],
  [xyToIdx(1,4),'505'], [xyToIdx(2,4),'435'], [xyToIdx(3,4),'436'], [xyToIdx(4,4),'437'], [xyToIdx(5,4),'438'],
  [xyToIdx(1,5),'503'], [xyToIdx(2,5),'513'], [xyToIdx(3,5),'523'], [xyToIdx(4,5),'551'], [xyToIdx(5,5),'552'], [xyToIdx(6,5),'553'],
  [xyToIdx(7,5),'555'], [xyToIdx(8,5),'556'], [xyToIdx(9,5),'557'], [xyToIdx(10,5),'558'], [xyToIdx(11,5),'568'],
  [xyToIdx(1,6),'502'], [xyToIdx(2,6),'512'], [xyToIdx(3,6),'522'], [xyToIdx(4,6),'561'], [xyToIdx(5,6),'562'], [xyToIdx(6,6),'563'],
  [xyToIdx(7,6),'565'], [xyToIdx(8,6),'566'], [xyToIdx(9,6),'578'], [xyToIdx(10,6),'567'],
  [xyToIdx(1,7),'501'], [xyToIdx(2,7),'511'], [xyToIdx(3,7),'521'], [xyToIdx(7,7),'512'], [xyToIdx(8,7),'573'], [xyToIdx(9,7),'575'], [xyToIdx(10,7),'576'],
  [xyToIdx(1,8),'478'], [xyToIdx(2,8),'479'], [xyToIdx(7,8),'582'], [xyToIdx(10,8),'487'],
  [xyToIdx(2,9),'490'], [xyToIdx(3,9),'491'], [xyToIdx(4,9),'492'], [xyToIdx(5,9),'493'], [xyToIdx(6,9),'494'],
  [xyToIdx(7,9),'581'], [xyToIdx(8,9),'583'], [xyToIdx(9,9),'585'], [xyToIdx(10,9),'586'], [xyToIdx(11,9),'587'],
]);

/***** (6) 建立 Grid *****/
function buildGrid(){
  const grid = $('#grid'); grid.innerHTML = '';
  for(let i=0;i<CELLS;i++){
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.dataset.idx = i;
    cell.setAttribute('data-dropzone','cell');

    const head = document.createElement('div'); head.className='head';
    const input = document.createElement('input');
    input.className='table-name';
    input.placeholder = `桌名 #${i+1}`;

    // 先套固定桌名（若有），否則才讀 localStorage
    if (PRESET_TABLES.has(i)) {
      input.value = PRESET_TABLES.get(i);
      input.readOnly = true;
      input.dataset.fixed = '1';
      input.title = '固定桌名（由主控設定）';
    } else {
      input.value = getTableName(i);
      input.addEventListener('input', () => {
        setTableName(i, input.value.trim());
      });
    }

    // 人數顯示
    const count = document.createElement('span');
    count.className = 'head-count';
    count.textContent = '0';

    // 右側 + 按鈕（點擊查看該格 Leader 的成員）
    const plus = document.createElement('button');
    plus.type = 'button';
    plus.className = 'table-plus';
    plus.textContent = '+';
    plus.title = '查看此桌 Leader 的成員';
    plus.addEventListener('click', ()=>{
      const L = getLeaderAtCell(i);
      if (L) openPopover(L);
      else toast('此桌目前沒有 Leader');
    });

    head.append(input, count, plus);

    const drop = document.createElement('div'); drop.className='drop';
    cell.append(head, drop);

    // DnD 事件
    cell.addEventListener('dragover', (e)=>{ e.preventDefault(); cell.classList.add('dragover'); });
    cell.addEventListener('dragleave', ()=> cell.classList.remove('dragover'));
    cell.addEventListener('drop', (e)=>{ e.preventDefault(); cell.classList.remove('dragover'); onDropToCell(i, e); });

    grid.appendChild(cell);
  }
}

/***** (7) 產生 Pill —— 僅名稱（不再有圓圈） *****/
function makePill(leader){
  const pill = document.createElement('button'); pill.type='button'; pill.className='pill'; pill.draggable=true;
  const nm  = document.createElement('span'); nm.className='name'; nm.textContent = leader;
  pill.append(nm);
  pill.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', leader); e.dataTransfer.effectAllowed='move'; });
  return pill;
}

/***** (8) Dock 渲染 *****/
function buildDock(){
  const body = $('#dockBody'); body.innerHTML='';
  const list = state.leaders.filter(L => (state.pos.get(L)?.type!=='cell'));
  if(!list.length){ const ph=document.createElement('div'); ph.className='placeholder'; ph.textContent='（目前無可用 Leader）'; body.appendChild(ph); }
  for(const L of list){ body.appendChild(makePill(L)); }
  $('#dockCount').textContent = `${state.leaders.length} 位`;

  // Dock 作為 dropzone
  body.addEventListener('dragover', e=>{ e.preventDefault(); });
  body.addEventListener('drop', e=>{ e.preventDefault(); const leader=e.dataTransfer.getData('text/plain'); if(!leader) return; state.pos.set(leader,{type:'dock'}); buildDock(); $$(`.cell`).forEach((c,idx)=>{ renderCellLeader(idx); }); });
}

/***** (9) 取得/設定 Cell 內 leader *****/
function getLeaderAtCell(idx){
  for(const [L, pos] of state.pos){ if(pos.type==='cell' && pos.idx===idx) return L; }
  return '';
}
function updateCellCount(idx){
  const cell = $(`.cell[data-idx="${idx}"]`); if(!cell) return;
  const L = getLeaderAtCell(idx);
  const cnt = L ? (state.membersByLeader.get(L)?.length || 0) : 0;
  const badge = cell.querySelector('.head-count');
  if (badge) badge.textContent = String(cnt);
}
function renderCellLeader(idx){
  const cell = $(`.cell[data-idx="${idx}"]`); if(!cell) return;
  const drop = cell.querySelector('.drop'); drop.innerHTML='';
  const L = getLeaderAtCell(idx);
  if(L){ drop.appendChild(makePill(L)); }
  updateCellCount(idx);
}

/***** (10) Drop 到 Cell 的邏輯（覆蓋/交換） *****/
function onDropToCell(idx, e){
  const leader = e.dataTransfer.getData('text/plain'); if(!leader) return;
  const occupied = getLeaderAtCell(idx);
  const src = state.pos.get(leader);
  if(state.swapMode){
    if(occupied){
      if(src && src.type==='cell'){
        const srcPos = { ...src };
        state.pos.set(leader, {type:'cell', idx});
        state.pos.set(occupied, {type:'cell', idx:srcPos.idx});
        renderCellLeader(idx);
        renderCellLeader(srcPos.idx);
      }else{
        state.pos.set(occupied, {type:'dock'}); buildDock();
        state.pos.set(leader, {type:'cell', idx}); renderCellLeader(idx);
      }
    }else{
      state.pos.set(leader, {type:'cell', idx}); renderCellLeader(idx);
      if(src && src.type==='cell') renderCellLeader(src.idx);
    }
  }else{
    if(occupied){
      const occPos = state.pos.get(occupied);
      state.pos.set(occupied, {type:'dock'});
      if(occPos) buildDock();
    }
    state.pos.set(leader, {type:'cell', idx}); renderCellLeader(idx);
    if(src && src.type==='cell') renderCellLeader(src.idx);
  }
}

/***** (11) Popover *****/
function openPopover(leader){
  const list = state.membersByLeader.get(leader)||[];
  $('#poTitle').textContent = `Leader：${leader}（${list.length} 人）`;
  const box = $('#poList'); box.innerHTML='';
  for(const r of list){
    const row = document.createElement('div'); row.className='po-item';
    const flag = document.createElement('div'); flag.textContent = r.flag || '—';
    const nm = document.createElement('div'); nm.className='nm'; nm.textContent = r.name||'—';
    const ig = document.createElement('div'); ig.className='ig'; ig.textContent = r.ig||'';
    row.append(flag,nm,ig); box.appendChild(row);
  }
  $('#poBack').style.display='flex';
}
function closePopover(){ $('#poBack').style.display='none'; }
$('#poClose').addEventListener('click', closePopover);
$('#poBack').addEventListener('click', (e)=>{ if(e.target.id==='poBack') closePopover(); });

/***** (12) 自動排列 *****/
$('#btnAuto').addEventListener('click', ()=>{
  for(const L of state.leaders){ state.pos.set(L,{type:'dock'}); }
  buildDock();
  const sorted = [...state.leaders].sort((a,b)=>a.localeCompare(b));
  let k=0;
  for(let i=0;i<CELLS;i++){
    const L = sorted[k++]; if(!L) break;
    state.pos.set(L,{type:'cell', idx:i}); renderCellLeader(i);
  }
  buildDock();
});

/***** (12b) 依 roster 的 number 初始放置 Leader 到對應格子 *****/
function mapTableNamesToIdx() {
  const cells = $$('.cell');
  const map = new Map();
  for (const cell of cells) {
    const idx = parseInt(cell.dataset.idx, 10);
    const tn = cell.querySelector('.table-name')?.value?.trim() || '';
    if (tn) map.set(normKey(tn), idx);
  }
  return map;
}
function leaderPreferredNumber(leader) {
  const members = state.membersByLeader.get(leader) || [];
  const cnt = new Map();
  for (const m of members) {
    const n = (m.number || '').toString().trim();
    if (!n) continue;
    const key = normKey(n);
    cnt.set(key, (cnt.get(key) || 0) + 1);
  }
  let best = '', bestC = 0;
  for (const [k, c] of cnt) {
    if (c > bestC) { best = k; bestC = c; }
  }
  return best;
}
function applyInitialPlacementByNumber() {
  const name2idx = mapTableNamesToIdx();
  const used = new Set();
  for (const L of state.leaders) state.pos.set(L, { type:'dock' });
  for (const L of state.leaders) {
    const pref = leaderPreferredNumber(L);
    if (!pref) continue;
    const idx = name2idx.get(pref);
    if (typeof idx === 'number' && !used.has(idx) && !getLeaderAtCell(idx)) {
      state.pos.set(L, {type:'cell', idx});
      renderCellLeader(idx);
      used.add(idx);
    }
  }
  buildDock();
}

/***** (13) 儲存（bulkUpdateNumber → fallback updateNumber） *****/
$('#btnSave').addEventListener('click', saveAll);
async function saveAll(){
  if(!GAS_WEB_APP_URL || GAS_WEB_APP_URL.includes('XXXXXXXX')){ toast('請先設定 GAS_WEB_APP_URL'); return; }
  const payload = [];
  const countMap = new Map();
  for(const [L, arr] of state.membersByLeader){ if(!L) continue; countMap.set(L, arr.length); }

  const cells = $$('.cell');
  for(const cell of cells){
    const idx = parseInt(cell.dataset.idx,10);
    const tn = (cell.querySelector('.table-name')?.value || '').trim();
    const L = getLeaderAtCell(idx);

    if(!tn || !L) continue;

    const value = tn.slice(0,10);

    const members = state.membersByLeader.get(L)||[];
    for(const m of members){
      payload.push({ item:m.item, ig:m.ig, name:m.name, leader:L, number:value });
    }
  }

  if(!payload.length){ toast('沒有可儲存的格子'); return; }

  const bulkBody = JSON.stringify({ action:'bulkUpdateNumber', changes: payload, sheet:'roster', ts:Date.now() });
  let ok = await tryPost(GAS_WEB_APP_URL, bulkBody);
  if(!ok){
    let all = true;
    for(const ch of payload){
      const body = JSON.stringify({ action:'updateNumber', item: ch.item, ig:ch.ig, name:ch.name, number: ch.number, sheet:'roster', ts:Date.now() });
      const one = await tryPost(GAS_WEB_APP_URL, body);
      if(!one) all = false;
    }
    ok = all;
  }
  toast(ok ? '已回填 number' : '回填失敗，請稍後再試');
}

/* 保持原本的 tryPost（可讀 JSON 成功回覆） */
async function tryPost(url, body){
  try{
    const res = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body,
      mode:'cors',
      cache:'no-store'
    });
    const text = await res.text();
    let json = null;
    try { json = JSON.parse(text); } catch(_) {}
    console.info('[POST]', url, res.status, res.statusText, json ?? text);

    if (res.ok && json && (json.ok === true || typeof json.updated === 'number' || typeof json.requested === 'number')) return true;

    toast(`伺服器回覆：${(json? JSON.stringify(json): text).slice(0,300)}`);
    return false;
  }catch(err){
    console.warn('POST error', err);
    toast('網路錯誤：' + err.message);
    return false;
  }
}

/***** (14) 讀取 roster（加入 cache buster + 寬鬆解析） *****/
async function loadRoster(){
  const url = `${ROSTER_URL}&_=${Date.now()}`;
  const res = await fetch(url, { cache:'no-store', mode:'cors' });
  if(!res.ok) throw new Error(`Roster fetch failed: ${res.status} ${res.statusText}`);
  const text = await res.text();
  const m = text.replace(/^[\uFEFF\s]+|[\s]+$/g,'').match(/setResponse\(([\s\S]*)\)\s*;?\s*$/);
  if(!m) throw new Error('gviz parse failed');
  const j = JSON.parse(m[1]);
  const cols = (j.table?.cols||[]).map(c=>c?.label||'');
  const rows = (j.table?.rows||[]);

  const data = rows.map(r=>{
    const obj = {};
    (r.c||[]).forEach((cell, i)=>{ obj[cols[i]||`c${i}`] = (cell && (cell.v ?? cell.f)) ?? ''; });
    return obj;
  });

  const normalized = data.map(r=>{
    const o = {}; for(const k of needKeys){ const hit = Object.keys(r).find(x => normKey(x) === normKey(k)); o[k] = (hit ? r[hit] : '') ?? ''; }
    o.leader = (o.leader||'').toString().trim();
    o.name   = (o.name  ||'').toString().trim();
    o.ig     = (o.ig    ||'').toString().trim();
    return o;
  });

  state.rows = normalized;
  const map = new Map();
  for(const row of normalized){ const key = (row.leader||'').trim(); if(!map.has(key)) map.set(key, []); map.get(key).push(row); }
  map.delete('');
  state.membersByLeader = map;
  state.leaders = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b));

  console.info('[ROSTER] rows:', normalized.length, 'leaders:', state.leaders.length);
}

/***** (15) 初始化 *****/
async function init(){
  const rng = $('#colw'); const val = $('#colwVal');
  const syncColw = ()=>{ document.documentElement.style.setProperty('--colw', `${rng.value}px`); val.textContent = `${rng.value}px`; };
  rng.addEventListener('input', syncColw); syncColw();

  $('#btnMode').addEventListener('click', (e)=>{ state.swapMode = !state.swapMode; e.currentTarget.setAttribute('aria-pressed', String(state.swapMode)); e.currentTarget.textContent = state.swapMode ? '交換模式' : '覆蓋模式'; });

  buildGrid();
  try{
    await loadRoster();
    buildDock();
    applyInitialPlacementByNumber();
  }catch(err){ console.error(err); toast('名單載入失敗，請檢查權限/分頁名'); }
}

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
